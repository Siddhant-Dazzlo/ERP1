{% extends "base.html" %}

{% block title %}Quotation Details - {{ quotation.quotation_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('sales.quotations') }}">Quotations</a></li>
                        <li class="breadcrumb-item active">Quotation Details</li>
                    </ol>
                </div>
                <h4 class="page-title">Quotation Details</h4>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Quotation Header -->
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h3 class="mb-1">{{ quotation.quotation_number }}</h3>
                            <p class="text-muted mb-0">{{ quotation.subject }}</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="d-flex justify-content-md-end gap-2">
                                <a href="{{ url_for('sales.edit_quotation', quotation_id=quotation.id) }}" class="btn btn-primary">
                                    <i class="bi bi-pencil me-1"></i>Edit
                                </a>
                                <button class="btn btn-outline-success" onclick="convertToInvoice()">
                                    <i class="bi bi-receipt me-1"></i>Convert to Invoice
                                </button>
                                <button class="btn btn-outline-info" onclick="duplicateQuotation()">
                                    <i class="bi bi-files me-1"></i>Duplicate
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="downloadPDF()"><i class="bi bi-file-pdf me-2"></i>Download PDF</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="sendEmail()"><i class="bi bi-envelope me-2"></i>Send Email</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="printQuotation()"><i class="bi bi-printer me-2"></i>Print</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteQuotation()"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Quotation Information -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quotation Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Quotation Number</label>
                                <p class="form-control-plaintext">{{ quotation.quotation_number }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Status</label>
                                <p class="form-control-plaintext">
                                    <span class="badge bg-{{ 'success' if quotation.status.value == 'sent' else 'warning' if quotation.status.value == 'draft' else 'info' if quotation.status.value == 'viewed' else 'danger' if quotation.status.value == 'expired' else 'secondary' }}">
                                        {{ quotation.status.value.title() }}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Quotation Date</label>
                                <p class="form-control-plaintext">{{ quotation.quotation_date.strftime('%B %d, %Y') if quotation.quotation_date else 'N/A' }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Valid Until</label>
                                <p class="form-control-plaintext">
                                    {% if quotation.valid_until %}
                                        {{ quotation.valid_until.strftime('%B %d, %Y') }}
                                        {% if quotation.is_expired %}
                                            <span class="badge bg-danger ms-2">Expired</span>
                                        {% endif %}
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Customer</label>
                                <p class="form-control-plaintext">
                                    <a href="{{ url_for('sales.customer_detail', customer_id=quotation.customer.id) }}">
                                        {{ quotation.customer.name }}
                                    </a>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Sales Person</label>
                                <p class="form-control-plaintext">{{ quotation.sales_person.get_full_name() if quotation.sales_person else 'Not assigned' }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Subject</label>
                        <p class="form-control-plaintext">{{ quotation.subject or 'No subject' }}</p>
                    </div>

                    {% if quotation.notes %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Notes</label>
                        <p class="form-control-plaintext">{{ quotation.notes }}</p>
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Currency</label>
                                <p class="form-control-plaintext">{{ quotation.currency or 'INR' }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tax Rate</label>
                                <p class="form-control-plaintext">{{ quotation.tax_rate or 0 }}%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products & Services -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Products & Services</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Product/Service</th>
                                    <th class="text-center">Quantity</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-center">Discount</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if quotation.items %}
                                    {% for item in quotation.items %}
                                    <tr>
                                        <td>
                                            <div>
                                                <strong>{{ item.product.name if item.product else 'Product not found' }}</strong>
                                                {% if item.product and item.product.description %}
                                                    <br><small class="text-muted">{{ item.product.description[:100] }}{% if item.product.description|length > 100 %}...{% endif %}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="text-center">{{ item.quantity }}</td>
                                        <td class="text-end">₹{{ "{:,.2f}".format(item.unit_price) }}</td>
                                        <td class="text-center">{{ item.discount or 0 }}%</td>
                                        <td class="text-end">₹{{ "{:,.2f}".format(item.total_amount) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No products added</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Terms and Conditions -->
            {% if quotation.terms_conditions %}
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Terms & Conditions</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ quotation.terms_conditions }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Summary -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Financial Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>₹{{ "{:,.2f}".format(quotation.subtotal) }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Discount:</span>
                        <span>₹{{ "{:,.2f}".format(quotation.total_discount) }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax ({{ quotation.tax_rate or 0 }}%):</span>
                        <span>₹{{ "{:,.2f}".format(quotation.tax_amount) }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>Total:</span>
                        <span class="text-primary">₹{{ "{:,.2f}".format(quotation.grand_total) }}</span>
                    </div>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Customer Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Company</label>
                        <p class="form-control-plaintext">{{ quotation.customer.name }}</p>
                    </div>
                    
                    {% if quotation.customer.email %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Email</label>
                        <p class="form-control-plaintext">
                            <a href="mailto:{{ quotation.customer.email }}">{{ quotation.customer.email }}</a>
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if quotation.customer.phone %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Phone</label>
                        <p class="form-control-plaintext">
                            <a href="tel:{{ quotation.customer.phone }}">{{ quotation.customer.phone }}</a>
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if quotation.customer.address %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Address</label>
                        <p class="form-control-plaintext">{{ quotation.customer.address }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quotation Timeline -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Created</h6>
                                <p class="text-muted mb-0">{{ quotation.created_at.strftime('%B %d, %Y at %I:%M %p') if quotation.created_at else 'N/A' }}</p>
                            </div>
                        </div>
                        
                        {% if quotation.sent_at %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Sent to Customer</h6>
                                <p class="text-muted mb-0">{{ quotation.sent_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if quotation.viewed_at %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Viewed by Customer</h6>
                                <p class="text-muted mb-0">{{ quotation.viewed_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if quotation.valid_until %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-{{ 'danger' if quotation.is_expired else 'warning' }}"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Valid Until</h6>
                                <p class="text-muted mb-0">{{ quotation.valid_until.strftime('%B %d, %Y') }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="sendReminder()">
                            <i class="bi bi-bell me-1"></i>Send Reminder
                        </button>
                        <button class="btn btn-outline-success" onclick="markAsAccepted()">
                            <i class="bi bi-check-circle me-1"></i>Mark as Accepted
                        </button>
                        <button class="btn btn-outline-warning" onclick="extendValidity()">
                            <i class="bi bi-calendar-plus me-1"></i>Extend Validity
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Records -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Related Records</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="relatedTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="emails-tab" data-bs-toggle="tab" data-bs-target="#emails" type="button" role="tab">
                                <i class="bi bi-envelope me-1"></i>Email History
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab">
                                <i class="bi bi-activity me-1"></i>Activity Log
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices" type="button" role="tab">
                                <i class="bi bi-receipt me-1"></i>Related Invoices
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="relatedTabsContent">
                        <!-- Email History -->
                        <div class="tab-pane fade show active" id="emails" role="tabpanel">
                            {% if email_history %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Subject</th>
                                                <th>Recipient</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for email in email_history %}
                                            <tr>
                                                <td>{{ email.sent_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                                <td>{{ email.subject }}</td>
                                                <td>{{ email.recipient }}</td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if email.status == 'sent' else 'warning' if email.status == 'pending' else 'danger' }}">
                                                        {{ email.status.title() }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="resendEmail({{ email.id }})">
                                                        <i class="bi bi-arrow-repeat"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-envelope fs-1 mb-3"></i>
                                    <p>No email history found</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Activity Log -->
                        <div class="tab-pane fade" id="activities" role="tabpanel">
                            {% if activity_log %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Activity</th>
                                                <th>User</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for activity in activity_log %}
                                            <tr>
                                                <td>{{ activity.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                                <td>
                                                    <span class="badge bg-{{ 'primary' if activity.type == 'created' else 'success' if activity.type == 'updated' else 'info' if activity.type == 'sent' else 'warning' }}">
                                                        {{ activity.type.title() }}
                                                    </span>
                                                </td>
                                                <td>{{ activity.user.get_full_name() if activity.user else 'System' }}</td>
                                                <td>{{ activity.details }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-activity fs-1 mb-3"></i>
                                    <p>No activity log found</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Related Invoices -->
                        <div class="tab-pane fade" id="invoices" role="tabpanel">
                            {% if related_invoices %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Invoice #</th>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for invoice in related_invoices %}
                                            <tr>
                                                <td>
                                                    <a href="{{ url_for('sales.invoice_detail', invoice_id=invoice.id) }}">
                                                        {{ invoice.invoice_number }}
                                                    </a>
                                                </td>
                                                <td>{{ invoice.invoice_date.strftime('%Y-%m-%d') }}</td>
                                                <td>₹{{ "{:,.2f}".format(invoice.grand_total) }}</td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if invoice.status.value == 'paid' else 'warning' if invoice.status.value == 'pending' else 'danger' }}">
                                                        {{ invoice.status.value.title() }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <a href="{{ url_for('sales.invoice_detail', invoice_id=invoice.id) }}" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-receipt fs-1 mb-3"></i>
                                    <p>No related invoices found</p>
                                    <button class="btn btn-primary" onclick="convertToInvoice()">
                                        <i class="bi bi-receipt me-1"></i>Convert to Invoice
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 3px #dee2e6;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: -29px;
    top: 12px;
    width: 2px;
    height: calc(100% + 8px);
    background-color: #dee2e6;
}

.timeline-content h6 {
    margin-bottom: 5px;
    font-size: 0.875rem;
}

.timeline-content p {
    font-size: 0.75rem;
}
</style>

<script>
function convertToInvoice() {
    if (confirm('Convert this quotation to an invoice?')) {
        window.location.href = "{{ url_for('sales.convert_quotation_to_invoice', quotation_id=quotation.id) }}";
    }
}

function duplicateQuotation() {
    if (confirm('Create a copy of this quotation?')) {
        window.location.href = "{{ url_for('sales.duplicate_quotation', quotation_id=quotation.id) }}";
    }
}

function downloadPDF() {
    window.open("{{ url_for('sales.download_quotation_pdf', quotation_id=quotation.id) }}", '_blank');
}

function sendEmail() {
    if (confirm('Send this quotation to the customer?')) {
        // Implement send email functionality
        alert('Send email functionality will be implemented');
    }
}

function printQuotation() {
    window.print();
}

function deleteQuotation() {
    if (confirm('Are you sure you want to delete this quotation? This action cannot be undone.')) {
        fetch("{{ url_for('sales.delete_quotation', quotation_id=quotation.id) }}", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Quotation deleted successfully!');
                window.location.href = "{{ url_for('sales.quotations') }}";
            } else {
                alert('Error: ' + data.message);
            }
        });
    }
}

function sendReminder() {
    if (confirm('Send a reminder to the customer?')) {
        // Implement send reminder functionality
        alert('Send reminder functionality will be implemented');
    }
}

function markAsAccepted() {
    if (confirm('Mark this quotation as accepted?')) {
        // Implement mark as accepted functionality
        alert('Mark as accepted functionality will be implemented');
    }
}

function extendValidity() {
    if (confirm('Extend the validity of this quotation?')) {
        // Implement extend validity functionality
        alert('Extend validity functionality will be implemented');
    }
}

function resendEmail(emailId) {
    if (confirm('Resend this email?')) {
        // Implement resend email functionality
        alert('Resend email functionality will be implemented');
    }
}
</script>
{% endblock %}

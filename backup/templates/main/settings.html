{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Settings</li>
                    </ol>
                </div>
                <h4 class="page-title">Company Settings</h4>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="header-title">Company Information</h4>
                    <p class="text-muted mb-0">Update your company details and preferences.</p>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.company_settings') }}" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="company_name" class="form-label">Company Name *</label>
                                    <input type="text" class="form-control" id="company_name" name="name" 
                                           value="{{ company.name }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="subdomain" class="form-label">Subdomain *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="subdomain" name="subdomain" 
                                               value="{{ company.subdomain }}" required>
                                        <span class="input-group-text">.example.com</span>
                                    </div>
                                    <small class="form-text text-muted">This will be your unique URL for accessing the system.</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="domain" class="form-label">Custom Domain</label>
                                    <input type="text" class="form-control" id="domain" name="domain" 
                                           value="{{ company.domain or '' }}" placeholder="yourcompany.com">
                                    <small class="form-text text-muted">Optional: Use your own domain instead of subdomain.</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="website" class="form-label">Website</label>
                                    <input type="url" class="form-control" id="website" name="website" 
                                           value="{{ company.website or '' }}" placeholder="https://yourcompany.com">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Company Email</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ company.email or '' }}" placeholder="info@yourcompany.com">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Company Phone</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" 
                                           value="{{ company.phone or '' }}" placeholder="+1 (555) 123-4567">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="3" 
                                      placeholder="Enter your company address">{{ company.address or '' }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city" 
                                           value="{{ company.city or '' }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="state" class="form-label">State/Province</label>
                                    <input type="text" class="form-control" id="state" name="state" 
                                           value="{{ company.state or '' }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="zip_code" class="form-label">ZIP/Postal Code</label>
                                    <input type="text" class="form-control" id="zip_code" name="zip_code" 
                                           value="{{ company.zip_code or '' }}">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="country" class="form-label">Country</label>
                                    <select class="form-select" id="country" name="country">
                                        <option value="">Select Country</option>
                                        <option value="US" {{ 'selected' if company.country == 'US' }}>United States</option>
                                        <option value="CA" {{ 'selected' if company.country == 'CA' }}>Canada</option>
                                        <option value="UK" {{ 'selected' if company.country == 'UK' }}>United Kingdom</option>
                                        <option value="AU" {{ 'selected' if company.country == 'AU' }}>Australia</option>
                                        <option value="DE" {{ 'selected' if company.country == 'DE' }}>Germany</option>
                                        <option value="FR" {{ 'selected' if company.country == 'FR' }}>France</option>
                                        <option value="IN" {{ 'selected' if company.country == 'IN' }}>India</option>
                                        <option value="JP" {{ 'selected' if company.country == 'JP' }}>Japan</option>
                                        <option value="Other" {{ 'selected' if company.country and company.country not in ['US', 'CA', 'UK', 'AU', 'DE', 'FR', 'IN', 'JP'] }}>Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="industry" class="form-label">Industry</label>
                                    <select class="form-select" id="industry" name="industry">
                                        <option value="">Select Industry</option>
                                        <option value="Technology" {{ 'selected' if company.industry == 'Technology' }}>Technology</option>
                                        <option value="Healthcare" {{ 'selected' if company.industry == 'Healthcare' }}>Healthcare</option>
                                        <option value="Finance" {{ 'selected' if company.industry == 'Finance' }}>Finance</option>
                                        <option value="Manufacturing" {{ 'selected' if company.industry == 'Manufacturing' }}>Manufacturing</option>
                                        <option value="Retail" {{ 'selected' if company.industry == 'Retail' }}>Retail</option>
                                        <option value="Education" {{ 'selected' if company.industry == 'Education' }}>Education</option>
                                        <option value="Real Estate" {{ 'selected' if company.industry == 'Real Estate' }}>Real Estate</option>
                                        <option value="Consulting" {{ 'selected' if company.industry == 'Consulting' }}>Consulting</option>
                                        <option value="Other" {{ 'selected' if company.industry and company.industry not in ['Technology', 'Healthcare', 'Finance', 'Manufacturing', 'Retail', 'Education', 'Real Estate', 'Consulting'] }}>Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="company_size" class="form-label">Company Size</label>
                                    <select class="form-select" id="company_size" name="size">
                                        <option value="">Select Size</option>
                                        <option value="1-10" {{ 'selected' if company.size == '1-10' }}>1-10 employees</option>
                                        <option value="11-50" {{ 'selected' if company.size == '11-50' }}>11-50 employees</option>
                                        <option value="51-200" {{ 'selected' if company.size == '51-200' }}>51-200 employees</option>
                                        <option value="201-500" {{ 'selected' if company.size == '201-500' }}>201-500 employees</option>
                                        <option value="501-1000" {{ 'selected' if company.size == '501-1000' }}>501-1000 employees</option>
                                        <option value="1000+" {{ 'selected' if company.size == '1000+' }}>1000+ employees</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="logo" class="form-label">Company Logo</label>
                                    <input type="file" class="form-control" id="logo" name="logo" accept="image/*">
                                    <small class="form-text text-muted">Recommended size: 200x200px, Max size: 2MB</small>
                                </div>
                            </div>
                        </div>

                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-content-save me-1"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Current Logo -->
            <div class="card">
                <div class="card-header">
                    <h4 class="header-title">Current Logo</h4>
                </div>
                <div class="card-body text-center">
                    {% if company.logo_url %}
                        <img src="{{ company.logo_url }}" alt="Company Logo" class="img-fluid rounded" style="max-width: 200px;">
                    {% else %}
                        <div class="bg-light rounded p-4">
                            <i class="mdi mdi-image text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2 mb-0">No logo uploaded</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Subscription Info -->
            <div class="card">
                <div class="card-header">
                    <h4 class="header-title">Subscription</h4>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Current Plan:</span>
                        <strong>{{ company.subscription_plan.value.title() }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Max Users:</span>
                        <strong>{{ company.max_users if company.max_users > 0 else 'Unlimited' }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Storage Limit:</span>
                        <strong>{{ company.max_storage_gb if company.max_storage_gb > 0 else 'Unlimited' }} GB</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Status:</span>
                        <span class="badge bg-success">Active</span>
                    </div>
                    
                    <div class="mt-3">
                        <a href="{{ url_for('billing.subscription') }}" class="btn btn-outline-primary btn-sm w-100">
                            <i class="mdi mdi-cog me-1"></i>Manage Subscription
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h4 class="header-title">Quick Actions</h4>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.users') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="mdi mdi-account-group me-1"></i>Manage Users
                        </a>
                        <a href="{{ url_for('admin.reports') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="mdi mdi-chart-line me-1"></i>View Reports
                        </a>
                        <a href="{{ url_for('admin.audit_log') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="mdi mdi-history me-1"></i>Audit Log
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Form validation
    $('form').on('submit', function(e) {
        var isValid = true;
        
        // Check required fields
        $(this).find('[required]').each(function() {
            if (!$(this).val()) {
                isValid = false;
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });
        
        // Validate subdomain format
        var subdomain = $('#subdomain').val();
        var subdomainRegex = /^[a-z0-9-]+$/;
        if (subdomain && !subdomainRegex.test(subdomain)) {
            $('#subdomain').addClass('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            toastr.error('Please fill in all required fields correctly.');
        }
    });
    
    // Real-time validation
    $('input, select').on('blur', function() {
        if ($(this).hasClass('is-invalid')) {
            $(this).removeClass('is-invalid');
        }
    });
    
    // Logo preview
    $('#logo').on('change', function() {
        var file = this.files[0];
        if (file) {
            // Check file size (2MB limit)
            if (file.size > 2 * 1024 * 1024) {
                toastr.error('File size must be less than 2MB');
                $(this).val('');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                toastr.error('Please select an image file');
                $(this).val('');
                return;
            }
            
            // Preview image
            var reader = new FileReader();
            reader.onload = function(e) {
                $('.card-body img').attr('src', e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Auto-generate subdomain from company name
    $('#company_name').on('input', function() {
        var companyName = $(this).val();
        if (companyName && !$('#subdomain').val()) {
            var subdomain = companyName.toLowerCase()
                .replace(/[^a-z0-9]/g, '')
                .substring(0, 20);
            $('#subdomain').val(subdomain);
        }
    });
});
</script>
{% endblock %}
